<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Anastacio ¬∑ Panel Admin</title>
<link rel="icon" type="image/png" href="https://res.cloudinary.com/dp9l5i19b/image/upload/w_32,h_32,c_fit/logooficial_cys7ex.webp">
<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#C9A24D">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Anastacio Admin">
<link rel="apple-touch-icon" href="/icon-192.png">
<meta name="mobile-web-app-capable" content="yes">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{--dark:#071826;--dark2:#0A1F33;--dark3:#0D2844;--gold:#C9A24D;--gold-l:#E6C76B;--cta:#F26B1D;--green:#25D366;--red:#C9442B;--cream:#F5F5F5;--muted:#A0B4C0;--amber:#F59E0B;--blue:#3B82F6;--purple:#8B5CF6;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--dark);color:var(--cream);font-family:"Montserrat",sans-serif;min-height:100vh;}
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:var(--dark);}
::-webkit-scrollbar-thumb{background:rgba(201,162,77,.3);border-radius:3px;}
.admin-header{background:var(--dark2);border-bottom:1px solid rgba(201,162,77,.12);padding:.8rem 1.5rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,.4);}
.admin-header-left{display:flex;align-items:center;gap:.8rem;}
.admin-logo{height:36px;}
.admin-title{font-family:"Bebas Neue",sans-serif;font-size:1.4rem;letter-spacing:.1em;color:var(--gold);}
.admin-title span{color:var(--muted);font-size:.8rem;letter-spacing:.05em;}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px rgba(37,211,102,.6);animation:pulse 2s ease-in-out infinite;display:inline-block;margin-left:.4rem;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.5;transform:scale(.8);}}
.header-actions{display:flex;gap:.4rem;align-items:center;}
.h-btn{background:rgba(201,162,77,.08);border:1px solid rgba(201,162,77,.2);color:var(--gold);padding:.4rem .7rem;border-radius:8px;font-family:"Bebas Neue",sans-serif;font-size:.75rem;letter-spacing:.08em;cursor:pointer;transition:all .2s;white-space:nowrap;}
.h-btn:hover{background:var(--gold);color:var(--dark);}
.h-btn.danger{border-color:rgba(201,68,43,.3);color:var(--red);}
.h-btn.danger:hover{background:var(--red);color:white;}
.sound-toggle{background:none;border:1px solid rgba(201,162,77,.2);color:var(--muted);padding:.35rem .55rem;border-radius:8px;cursor:pointer;font-size:.9rem;transition:all .2s;}
.sound-toggle.on{color:var(--gold);border-color:var(--gold);}
.tabs{display:flex;gap:0;padding:0 1.5rem;background:var(--dark2);border-bottom:1px solid rgba(201,162,77,.06);overflow-x:auto;}
.tab{padding:.75rem 1.2rem;font-family:"Bebas Neue",sans-serif;font-size:.9rem;letter-spacing:.08em;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;position:relative;white-space:nowrap;flex-shrink:0;}
.tab:hover{color:var(--cream);}
.tab.active{color:var(--gold);border-bottom-color:var(--gold);}
.tab-badge{position:absolute;top:.4rem;right:.1rem;background:var(--cta);color:white;font-size:.55rem;font-family:"Montserrat",sans-serif;font-weight:700;padding:.05rem .35rem;border-radius:10px;min-width:16px;text-align:center;}
.date-filter{display:flex;gap:.4rem;padding:.8rem 1.5rem;align-items:center;flex-wrap:wrap;}
.df-btn{background:rgba(201,162,77,.06);border:1px solid rgba(201,162,77,.12);color:var(--muted);padding:.35rem .7rem;border-radius:6px;font-size:.7rem;font-family:"Montserrat",sans-serif;font-weight:600;cursor:pointer;transition:all .2s;letter-spacing:.03em;}
.df-btn:hover{color:var(--cream);border-color:rgba(201,162,77,.3);}
.df-btn.active{background:var(--gold);color:var(--dark);border-color:var(--gold);}
.df-label{font-size:.65rem;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-right:.3rem;}
.stats-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.7rem;padding:.8rem 1.5rem;}
.stat-card{background:var(--dark2);border:1px solid rgba(201,162,77,.08);border-radius:10px;padding:1rem;text-align:center;transition:all .3s;position:relative;overflow:hidden;}
.stat-card:hover{border-color:rgba(201,162,77,.25);transform:translateY(-1px);}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--gold);opacity:0;transition:opacity .3s;}
.stat-card:hover::before{opacity:1;}
.stat-value{font-family:"Bebas Neue",sans-serif;font-size:1.8rem;color:var(--gold);line-height:1;}
.stat-value.green{color:var(--green);}
.stat-value.red{color:var(--red);}
.stat-value.blue{color:var(--blue);}
.stat-value.purple{color:var(--purple);}
.stat-label{font-size:.6rem;color:var(--muted);letter-spacing:.12em;margin-top:.25rem;text-transform:uppercase;}
.stat-sub{font-size:.6rem;color:var(--muted);margin-top:.15rem;opacity:.7;}
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:.8rem;padding:0 1.5rem .8rem;}
.chart-card{background:var(--dark2);border:1px solid rgba(201,162,77,.08);border-radius:10px;padding:1rem;}
.chart-title{font-family:"Bebas Neue",sans-serif;font-size:.85rem;letter-spacing:.1em;color:var(--gold);margin-bottom:.8rem;}
.chart-wrap{position:relative;height:200px;}
.content{padding:0 1.5rem 1.5rem;}
.panel{display:none;}
.panel.active{display:block;}
.table-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem;flex-wrap:wrap;gap:.5rem;}
.table-title{font-family:"Bebas Neue",sans-serif;font-size:1rem;letter-spacing:.1em;color:var(--gold);}
.table-actions{display:flex;gap:.3rem;flex-wrap:wrap;}
.filter-select{background:var(--dark);color:var(--cream);border:1px solid rgba(201,162,77,.15);padding:.3rem .5rem;border-radius:6px;font-size:.7rem;font-family:"Montserrat",sans-serif;cursor:pointer;outline:none;}
.filter-select:focus{border-color:var(--gold);}
.export-btn{background:rgba(201,162,77,.08);border:1px solid rgba(201,162,77,.15);color:var(--gold);padding:.3rem .6rem;border-radius:6px;font-size:.65rem;font-family:"Bebas Neue",sans-serif;letter-spacing:.08em;cursor:pointer;transition:all .2s;}
.export-btn:hover{background:var(--gold);color:var(--dark);}
.table-wrap{overflow-x:auto;border-radius:10px;border:1px solid rgba(201,162,77,.08);background:var(--dark2);}
table{width:100%;border-collapse:collapse;font-size:.8rem;}
thead{background:rgba(201,162,77,.06);}
th{padding:.65rem .8rem;text-align:left;font-family:"Bebas Neue",sans-serif;font-size:.75rem;letter-spacing:.1em;color:var(--gold);border-bottom:1px solid rgba(201,162,77,.1);white-space:nowrap;}
td{padding:.6rem .8rem;border-bottom:1px solid rgba(255,255,255,.02);color:var(--cream);vertical-align:top;}
tr:hover td{background:rgba(201,162,77,.02);}
tr:last-child td{border-bottom:none;}
.status{display:inline-block;padding:.15rem .5rem;border-radius:50px;font-family:"Bebas Neue",sans-serif;font-size:.68rem;letter-spacing:.06em;white-space:nowrap;}
.status.pending{background:rgba(245,158,11,.12);color:var(--amber);border:1px solid rgba(245,158,11,.25);}
.status.confirmed{background:rgba(37,211,102,.12);color:var(--green);border:1px solid rgba(37,211,102,.25);}
.status.preparing{background:rgba(242,107,29,.12);color:var(--cta);border:1px solid rgba(242,107,29,.25);}
.status.ready{background:rgba(59,130,246,.12);color:var(--blue);border:1px solid rgba(59,130,246,.25);}
.status.delivered{background:rgba(201,162,77,.12);color:var(--gold);border:1px solid rgba(201,162,77,.25);}
.status.cancelled{background:rgba(201,68,43,.12);color:var(--red);border:1px solid rgba(201,68,43,.25);}
.otype{display:inline-block;padding:.15rem .5rem;border-radius:50px;font-size:.68rem;font-weight:600;white-space:nowrap;}
.otype.domicilio{background:rgba(37,211,102,.1);color:var(--green);}
.otype.recoger{background:rgba(201,162,77,.1);color:var(--gold);}
.otype.mesa{background:rgba(242,107,29,.1);color:var(--cta);}
.status-select{background:var(--dark);color:var(--cream);border:1px solid rgba(201,162,77,.18);padding:.25rem .4rem;border-radius:6px;font-size:.72rem;font-family:"Montserrat",sans-serif;cursor:pointer;outline:none;}
.status-select:focus{border-color:var(--gold);}
.items-list{font-size:.75rem;color:var(--muted);line-height:1.5;}
.items-list strong{color:var(--cream);}
.funnel{display:flex;flex-direction:column;gap:.5rem;padding:.5rem 0;}
.funnel-step{display:flex;align-items:center;gap:.8rem;}
.funnel-bar-wrap{flex:1;height:28px;background:rgba(255,255,255,.03);border-radius:6px;overflow:hidden;position:relative;}
.funnel-bar{height:100%;border-radius:6px;transition:width .8s ease;display:flex;align-items:center;padding:0 .6rem;min-width:fit-content;}
.funnel-bar span{font-family:"Bebas Neue",sans-serif;font-size:.75rem;color:white;letter-spacing:.05em;white-space:nowrap;}
.funnel-label{width:100px;font-size:.68rem;color:var(--muted);text-align:right;flex-shrink:0;letter-spacing:.03em;}
.funnel-count{width:45px;font-family:"Bebas Neue",sans-serif;font-size:.9rem;color:var(--cream);flex-shrink:0;}
.funnel-pct{width:35px;font-size:.6rem;color:var(--muted);flex-shrink:0;}
.top-list{display:flex;flex-direction:column;gap:.4rem;}
.top-item{display:flex;align-items:center;gap:.6rem;padding:.4rem .6rem;background:rgba(255,255,255,.02);border-radius:8px;}
.top-rank{font-family:"Bebas Neue",sans-serif;font-size:1.1rem;color:var(--gold);width:24px;text-align:center;flex-shrink:0;}
.top-name{flex:1;font-size:.78rem;}
.top-qty{font-family:"Bebas Neue",sans-serif;font-size:.9rem;color:var(--cream);flex-shrink:0;}
.top-rev{font-family:"Bebas Neue",sans-serif;font-size:.8rem;color:var(--gold);flex-shrink:0;width:70px;text-align:right;}
.empty{text-align:center;padding:3rem 2rem;color:var(--muted);}
.empty-icon{font-size:2.5rem;margin-bottom:.8rem;opacity:.35;}
.empty-text{font-size:.85rem;}
.notif-toast{position:fixed;top:1rem;right:1rem;background:var(--green);color:white;padding:.8rem 1.2rem;border-radius:10px;font-family:"Bebas Neue",sans-serif;font-size:.9rem;letter-spacing:.06em;box-shadow:0 8px 30px rgba(37,211,102,.4);transform:translateX(120%);transition:transform .3s ease;z-index:9999;}
.notif-toast.show{transform:translateX(0);}
@media(max-width:768px){
.stats-bar{grid-template-columns:repeat(2,1fr);gap:.5rem;padding:.6rem .8rem;}
.stat-card{padding:.7rem;}.stat-value{font-size:1.4rem;}
.charts-grid{grid-template-columns:1fr;padding:0 .8rem .6rem;}.chart-wrap{height:180px;}
.content{padding:0 .8rem .8rem;}
.admin-title span{display:none;}.admin-title{font-size:1.1rem;}.admin-logo{height:28px;}.admin-header{padding:.6rem .8rem;}
.header-actions{gap:.25rem;}.h-btn{padding:.3rem .5rem;font-size:.7rem;}
.tabs{padding:0 .8rem;}.tab{padding:.6rem .6rem;font-size:.78rem;}
.date-filter{padding:.6rem .8rem;}.funnel-label{width:70px;font-size:.6rem;}
.table-actions{gap:.2rem;}.filter-select{font-size:.65rem;padding:.25rem .35rem;}.export-btn{font-size:.6rem;padding:.25rem .4rem;}
#panel-orders .table-wrap table thead{display:none;}
#panel-orders .table-wrap table,#panel-orders .table-wrap table tbody,#panel-orders .table-wrap table tr,#panel-orders .table-wrap table td{display:block;width:100%;}
#panel-orders .table-wrap table tr{background:var(--dark2);border:1px solid rgba(201,162,77,.08);border-radius:10px;margin-bottom:.6rem;padding:.7rem;position:relative;}
#panel-orders .table-wrap table tr:hover td{background:none;}
#panel-orders .table-wrap table td{border:none;padding:.2rem 0;font-size:.8rem;}
#panel-orders .table-wrap table td:nth-child(1){position:absolute;top:.7rem;right:.7rem;width:auto;text-align:right;font-size:.72rem;color:var(--muted);}
#panel-orders .table-wrap table td:nth-child(2){margin-bottom:.2rem;}
#panel-orders .table-wrap table td:nth-child(3){font-size:.82rem;margin-bottom:.3rem;padding-right:5rem;}
#panel-orders .table-wrap table td:nth-child(4){background:rgba(0,0,0,.12);border-radius:8px;padding:.5rem .6rem;margin:.3rem 0;}
#panel-orders .table-wrap table td:nth-child(5){font-size:1.1rem;padding-top:.3rem;display:inline-block;width:auto;}
#panel-orders .table-wrap table td:nth-child(6){display:inline-block;width:auto;float:right;padding-top:.3rem;}
#panel-orders .table-wrap{border:none;background:none;}
.status-select{font-size:.78rem;padding:.35rem .45rem;}
#panel-leads .table-wrap table thead{display:none;}
#panel-leads .table-wrap table,#panel-leads .table-wrap table tbody,#panel-leads .table-wrap table tr,#panel-leads .table-wrap table td{display:block;width:100%;}
#panel-leads .table-wrap table tr{background:var(--dark2);border:1px solid rgba(201,162,77,.08);border-radius:10px;margin-bottom:.4rem;padding:.6rem .7rem;}
#panel-leads .table-wrap table tr:hover td{background:none;}
#panel-leads .table-wrap table td{border:none;padding:.1rem 0;font-size:.8rem;}
#panel-leads .table-wrap table td:nth-child(1){font-size:.68rem;color:var(--muted);}
#panel-leads .table-wrap table td:nth-child(2){font-size:.9rem;font-weight:600;}
#panel-leads .table-wrap{border:none;background:none;}
}
</style>
</head>
<body>
<div id="login-screen" style="display:flex;align-items:center;justify-content:center;min-height:100vh;">
<div style="background:var(--dark2);border:1px solid rgba(201,162,77,.12);border-radius:14px;padding:2.2rem;max-width:360px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.5);">
<img src="https://res.cloudinary.com/dp9l5i19b/image/upload/f_auto,q_auto/logooficial_cys7ex.webp" alt="Anastacio" style="height:55px;margin-bottom:1.2rem;opacity:.85;">
<h2 style="font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:.1em;color:var(--gold);margin-bottom:.2rem;">PANEL ADMIN</h2>
<p style="color:var(--muted);font-size:.75rem;margin-bottom:1.3rem;">Solo personal autorizado</p>
<input type="email" id="login-email" placeholder="Email" style="width:100%;padding:.65rem .8rem;background:var(--dark);border:1px solid rgba(201,162,77,.15);color:var(--cream);font-family:'Montserrat',sans-serif;font-size:.85rem;margin-bottom:.5rem;outline:none;border-radius:8px;">
<input type="password" id="login-pass" placeholder="Contrase√±a" style="width:100%;padding:.65rem .8rem;background:var(--dark);border:1px solid rgba(201,162,77,.15);color:var(--cream);font-family:'Montserrat',sans-serif;font-size:.85rem;margin-bottom:.5rem;outline:none;border-radius:8px;">
<div id="login-error" style="color:var(--red);font-size:.75rem;margin-bottom:.5rem;display:none;"></div>
<button onclick="doLogin()" style="width:100%;padding:.7rem;background:var(--gold);color:var(--dark);border:none;font-family:'Bebas Neue',sans-serif;font-size:1.05rem;letter-spacing:.1em;cursor:pointer;border-radius:8px;transition:all .2s;">ENTRAR</button>
</div>
</div>
<div id="admin-app" style="display:none;">
<header class="admin-header">
<div class="admin-header-left">
<img src="https://res.cloudinary.com/dp9l5i19b/image/upload/f_auto,q_auto/logooficial_cys7ex.webp" alt="Anastacio" class="admin-logo">
<div class="admin-title">PANEL ADMIN <span>¬∑ Anastacio</span><span class="live-dot"></span></div>
</div>
<div class="header-actions">
<button class="sound-toggle" id="sound-toggle" onclick="toggleSound()">üîá</button>
<button class="h-btn" onclick="loadAll()">‚Üª REFRESH</button>
<button class="h-btn danger" onclick="doLogout()">SALIR</button>
</div>
</header>
<div class="tabs">
<div class="tab active" data-tab="dashboard" onclick="switchTab('dashboard',this)">üìä DASHBOARD</div>
<div class="tab" data-tab="orders" onclick="switchTab('orders',this)">üõí PEDIDOS <span class="tab-badge" id="orders-badge" style="display:none">0</span></div>
<div class="tab" data-tab="leads" onclick="switchTab('leads',this)">üë• LEADS <span class="tab-badge" id="leads-badge" style="display:none">0</span></div>
<div class="tab" data-tab="analytics" onclick="switchTab('analytics',this)">üìà ANALYTICS</div>
<div class="tab" data-tab="products" onclick="switchTab('products',this)">ü¶ê PRODUCTOS</div>
</div>
<div class="date-filter">
<span class="df-label">Periodo:</span>
<button class="df-btn active" onclick="setDateRange('today',this)">Hoy</button>
<button class="df-btn" onclick="setDateRange('yesterday',this)">Ayer</button>
<button class="df-btn" onclick="setDateRange('week',this)">7 d√≠as</button>
<button class="df-btn" onclick="setDateRange('month',this)">30 d√≠as</button>
<button class="df-btn" onclick="setDateRange('all',this)">Todo</button>
</div>
<div class="panel active" id="panel-dashboard">
<div class="stats-bar">
<div class="stat-card"><div class="stat-value" id="s-orders">‚Äî</div><div class="stat-label">Pedidos</div></div>
<div class="stat-card"><div class="stat-value green" id="s-revenue">‚Äî</div><div class="stat-label">Venta total</div></div>
<div class="stat-card"><div class="stat-value" id="s-ticket">‚Äî</div><div class="stat-label">Ticket promedio</div></div>
<div class="stat-card"><div class="stat-value red" id="s-pending">‚Äî</div><div class="stat-label">Pendientes</div></div>
<div class="stat-card"><div class="stat-value blue" id="s-domicilio">‚Äî</div><div class="stat-label">Domicilio</div><div class="stat-sub" id="s-domicilio-pct"></div></div>
<div class="stat-card"><div class="stat-value" id="s-recoger">‚Äî</div><div class="stat-label">Recoger</div><div class="stat-sub" id="s-recoger-pct"></div></div>
<div class="stat-card"><div class="stat-value purple" id="s-mesa">‚Äî</div><div class="stat-label">Mesa</div><div class="stat-sub" id="s-mesa-pct"></div></div>
<div class="stat-card"><div class="stat-value green" id="s-leads">‚Äî</div><div class="stat-label">Leads</div><div class="stat-sub" id="s-leads-sub"></div></div>
</div>
<div class="charts-grid">
<div class="chart-card"><div class="chart-title">üìä Ventas por d√≠a</div><div class="chart-wrap"><canvas id="chart-revenue"></canvas></div></div>
<div class="chart-card"><div class="chart-title">üõí Pedidos por tipo</div><div class="chart-wrap"><canvas id="chart-types"></canvas></div></div>
<div class="chart-card"><div class="chart-title">‚è∞ Pedidos por hora</div><div class="chart-wrap"><canvas id="chart-hours"></canvas></div></div>
<div class="chart-card"><div class="chart-title">üìà Embudo de conversi√≥n</div><div class="chart-wrap" style="height:auto;" id="funnel-wrap"><div class="funnel" id="funnel-chart"></div></div></div>
</div>
</div>
<div class="panel" id="panel-orders">
<div class="table-header"><div class="table-title">Historial de pedidos</div>
<div class="table-actions">
<select class="filter-select" id="filter-status" onchange="renderOrders()"><option value="all">Todos</option><option value="pending">Pendientes</option><option value="confirmed">Confirmados</option><option value="preparing">Preparando</option><option value="ready">Listos</option><option value="delivered">Entregados</option><option value="cancelled">Cancelados</option></select>
<select class="filter-select" id="filter-type" onchange="renderOrders()"><option value="all">Todos</option><option value="domicilio">Domicilio</option><option value="recoger">Recoger</option><option value="mesa">Mesa</option></select>
<button class="export-btn" onclick="exportOrders()">‚¨á CSV</button>
</div></div>
<div class="table-wrap"><table><thead><tr><th>HORA</th><th>TIPO</th><th>CLIENTE</th><th>PEDIDO</th><th>TOTAL</th><th>STATUS</th></tr></thead><tbody id="orders-body"><tr><td colspan="6"><div class="empty"><div class="empty-icon">ü¶ê</div><div class="empty-text">Cargando...</div></div></td></tr></tbody></table></div>
</div>
<div class="panel" id="panel-leads">
<div class="table-header"><div class="table-title">Base de leads</div>
<div class="table-actions">
<select class="filter-select" id="filter-source" onchange="renderLeads()"><option value="all">Todas</option><option value="bar">Barra</option><option value="modal">Modal</option></select>
<button class="export-btn" onclick="exportLeads()">‚¨á CSV</button>
</div></div>
<div class="table-wrap"><table><thead><tr><th>FECHA</th><th>NOMBRE</th><th>WHATSAPP</th><th>EMAIL</th><th>FUENTE</th></tr></thead><tbody id="leads-body"><tr><td colspan="5"><div class="empty"><div class="empty-icon">üë•</div><div class="empty-text">Cargando...</div></div></td></tr></tbody></table></div>
</div>
<div class="panel" id="panel-analytics">
<div class="stats-bar">
<div class="stat-card"><div class="stat-value green" id="a-conversion">‚Äî</div><div class="stat-label">Conversi√≥n</div><div class="stat-sub">Leads ‚Üí Pedidos</div></div>
<div class="stat-card"><div class="stat-value" id="a-repeat">‚Äî</div><div class="stat-label">Clientes repetidos</div><div class="stat-sub">2+ pedidos</div></div>
<div class="stat-card"><div class="stat-value blue" id="a-avg-items">‚Äî</div><div class="stat-label">Items por pedido</div></div>
<div class="stat-card"><div class="stat-value purple" id="a-cancel-rate">‚Äî</div><div class="stat-label">Cancelaci√≥n</div></div>
</div>
<div class="charts-grid">
<div class="chart-card"><div class="chart-title">üìä Venta por d√≠a de la semana</div><div class="chart-wrap"><canvas id="chart-weekday"></canvas></div></div>
<div class="chart-card"><div class="chart-title">üí∞ Distribuci√≥n de ticket</div><div class="chart-wrap"><canvas id="chart-ticket"></canvas></div></div>
</div>
</div>
<div class="panel" id="panel-products">
<div class="table-header"><div class="table-title">üèÜ Top productos m√°s vendidos</div></div>
<div class="top-list" id="top-products"></div>
</div>
</div>
<div class="notif-toast" id="notif-toast">ü¶ê ¬°NUEVO PEDIDO!</div>
<script>
var SUPABASE_URL='https://hqrwjlrqzslkwhwqcmnh.supabase.co';
var SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxcndqbHJxenNsa3dod3FjbW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIzMDYwMTcsImV4cCI6MjA4Nzg4MjAxN30.tNyO18E7lDNEYH28P_DGxSg9pf1yYysVpJuMwboJOoU';
var sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
var soundOn=false,allOrders=[],allLeads=[],knownOrderIds={},dateRange='today';
var chartRevenue,chartTypes,chartHours,chartWeekday,chartTicket;

async function doLogin(){var email=document.getElementById('login-email').value.trim();var pass=document.getElementById('login-pass').value;var err=document.getElementById('login-error');err.style.display='none';if(!email||!pass){err.textContent='Ingresa email y contrase√±a';err.style.display='block';return;}var{data,error}=await sb.auth.signInWithPassword({email:email,password:pass});if(error){err.textContent='Email o contrase√±a incorrectos';err.style.display='block';return;}showAdmin();}
document.getElementById('login-pass').addEventListener('keydown',function(e){if(e.key==='Enter')doLogin();});
function showAdmin(){document.getElementById('login-screen').style.display='none';document.getElementById('admin-app').style.display='block';loadAll();setupRealtime();}
async function doLogout(){await sb.auth.signOut();document.getElementById('admin-app').style.display='none';document.getElementById('login-screen').style.display='flex';document.getElementById('login-pass').value='';}
sb.auth.getSession().then(function(r){if(r.data.session)showAdmin();});

var notifAudio = new Audio('https://res.cloudinary.com/dp9l5i19b/video/upload/v1772311938/mixkit-software-interface-start-2574_najvah.wav');
notifAudio.volume = 0.5;
function toggleSound(){soundOn=!soundOn;var b=document.getElementById('sound-toggle');b.textContent=soundOn?'üîî':'üîá';b.classList.toggle('on',soundOn);if(soundOn){notifAudio.play().then(function(){notifAudio.pause();notifAudio.currentTime=0;}).catch(function(){});}}
function playNotifSound(){if(!soundOn)return;try{notifAudio.currentTime=0;notifAudio.play();}catch(e){}}
function showNotification(m){var t=document.getElementById('notif-toast');t.textContent=m;t.classList.add('show');playNotifSound();setTimeout(function(){t.classList.remove('show');},4000);}

function switchTab(tab,el){document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active');});document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active');});el.classList.add('active');document.getElementById('panel-'+tab).classList.add('active');}
function setDateRange(r,el){dateRange=r;document.querySelectorAll('.df-btn').forEach(function(b){b.classList.remove('active');});el.classList.add('active');renderAll();}
function getDateStart(){var n=new Date(),d;if(dateRange==='today'){d=new Date(n);d.setHours(0,0,0,0);}else if(dateRange==='yesterday'){d=new Date(n);d.setDate(d.getDate()-1);d.setHours(0,0,0,0);}else if(dateRange==='week'){d=new Date(n);d.setDate(d.getDate()-7);d.setHours(0,0,0,0);}else if(dateRange==='month'){d=new Date(n);d.setDate(d.getDate()-30);d.setHours(0,0,0,0);}else{d=new Date(2020,0,1);}return d;}
function getDateEnd(){if(dateRange==='yesterday'){var d=new Date();d.setHours(0,0,0,0);return d;}return new Date(2099,0,1);}
function filterByDate(a){var s=getDateStart(),e=getDateEnd();return a.filter(function(r){var d=new Date(r.created_at);return d>=s&&d<e;});}

function fTime(d){return new Date(d).toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',hour12:true});}
function fDate(d){return new Date(d).toLocaleDateString('es-MX',{day:'2-digit',month:'short',year:'numeric'})+' '+fTime(d);}
function fMoney(n){return'$'+Number(n).toLocaleString('es-MX');}
function fPct(n){return Math.round(n)+'%';}
function typeLabel(t){return{domicilio:'üõµ Domicilio',recoger:'ü•° Recoger',mesa:'üçΩ Mesa'}[t]||t;}
function statusLabel(s){return{pending:'Pendiente',confirmed:'Confirmado',preparing:'Preparando',ready:'Listo',delivered:'Entregado',cancelled:'Cancelado'}[s]||s;}

async function loadOrders(){var{data,error}=await sb.from('orders').select('*').order('created_at',{ascending:false}).limit(1000);if(error){console.error('Orders:',JSON.stringify(error));return;}allOrders=data||[];allOrders.forEach(function(o){knownOrderIds[o.id]=true;});}
async function loadLeads(){var{data,error}=await sb.from('leads').select('*').order('created_at',{ascending:false}).limit(1000);if(error){console.error('Leads:',JSON.stringify(error));return;}allLeads=data||[];}
async function loadAll(){await loadOrders();await loadLeads();renderAll();}
function renderAll(){renderDashboard();renderOrders();renderLeads();renderAnalytics();renderProducts();}

function renderDashboard(){
var orders=filterByDate(allOrders).filter(function(o){return o.status!=='cancelled';});
var pending=filterByDate(allOrders).filter(function(o){return o.status==='pending';});
var totalRev=0,domC=0,recC=0,mesC=0;
orders.forEach(function(o){totalRev+=Number(o.total);if(o.order_type==='domicilio')domC++;else if(o.order_type==='recoger')recC++;else mesC++;});
var n=orders.length;
document.getElementById('s-orders').textContent=n;
document.getElementById('s-revenue').textContent=fMoney(totalRev);
document.getElementById('s-ticket').textContent=n>0?fMoney(Math.round(totalRev/n)):'‚Äî';
document.getElementById('s-pending').textContent=pending.length;
document.getElementById('s-domicilio').textContent=domC;
document.getElementById('s-recoger').textContent=recC;
document.getElementById('s-mesa').textContent=mesC;
document.getElementById('s-domicilio-pct').textContent=n>0?fPct(domC/n*100):'';
document.getElementById('s-recoger-pct').textContent=n>0?fPct(recC/n*100):'';
document.getElementById('s-mesa-pct').textContent=n>0?fPct(mesC/n*100):'';
var fl=filterByDate(allLeads);
document.getElementById('s-leads').textContent=fl.length;
document.getElementById('s-leads-sub').textContent='de '+allLeads.length+' total';
var badge=document.getElementById('orders-badge');if(pending.length>0){badge.textContent=pending.length;badge.style.display='';}else badge.style.display='none';
var lb=document.getElementById('leads-badge');lb.textContent=allLeads.length;lb.style.display=allLeads.length>0?'':'none';
renderRevenueChart(orders);renderTypesChart(domC,recC,mesC);renderHoursChart(orders);renderFunnel(fl,orders);
}

function renderRevenueChart(orders){var days={};orders.forEach(function(o){var k=new Date(o.created_at).toLocaleDateString('es-MX',{day:'2-digit',month:'short'});days[k]=(days[k]||0)+Number(o.total);});var labels=Object.keys(days).reverse().slice(-14);var data=labels.map(function(l){return days[l];});var ctx=document.getElementById('chart-revenue');if(chartRevenue)chartRevenue.destroy();chartRevenue=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{data:data,backgroundColor:'rgba(201,162,77,.4)',borderColor:'#C9A24D',borderWidth:1,borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#A0B4C0',font:{size:9}},grid:{display:false}},y:{ticks:{color:'#A0B4C0',font:{size:9},callback:function(v){return'$'+v.toLocaleString();}},grid:{color:'rgba(255,255,255,.03)'}}}}});}

function renderTypesChart(d,r,m){var ctx=document.getElementById('chart-types');if(chartTypes)chartTypes.destroy();chartTypes=new Chart(ctx,{type:'doughnut',data:{labels:['Domicilio','Recoger','Mesa'],datasets:[{data:[d,r,m],backgroundColor:['rgba(37,211,102,.7)','rgba(201,162,77,.7)','rgba(242,107,29,.7)'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#A0B4C0',font:{size:10},padding:12}}}}});}

function renderHoursChart(orders){var hrs=new Array(24).fill(0);orders.forEach(function(o){hrs[new Date(o.created_at).getHours()]++;});var labels=[],data=[];for(var i=10;i<=23;i++){labels.push(i+':00');data.push(hrs[i]);}var ctx=document.getElementById('chart-hours');if(chartHours)chartHours.destroy();chartHours=new Chart(ctx,{type:'line',data:{labels:labels,datasets:[{data:data,borderColor:'#3B82F6',backgroundColor:'rgba(59,130,246,.1)',fill:true,tension:.4,pointRadius:3,pointBackgroundColor:'#3B82F6'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#A0B4C0',font:{size:9}},grid:{display:false}},y:{ticks:{color:'#A0B4C0',font:{size:9},stepSize:1},grid:{color:'rgba(255,255,255,.03)'}}}}});}

function renderFunnel(leads,orders){var el=document.getElementById('funnel-chart');var oc=orders.length,lc=leads.length;var ev=Math.max(lc*8,oc*15,50);var ec=Math.max(oc*3,lc);var steps=[{label:'Visitas (est.)',count:ev,color:'var(--blue)'},{label:'Leads',count:lc,color:'var(--purple)'},{label:'Carrito',count:ec,color:'var(--amber)'},{label:'Pedidos',count:oc,color:'var(--green)'}];var mx=Math.max.apply(null,steps.map(function(s){return s.count;}))||1;var h='';steps.forEach(function(s,i){var p=Math.max(s.count/mx*100,8);var cv=i>0&&steps[i-1].count>0?Math.round(s.count/steps[i-1].count*100)+'%':'100%';h+='<div class="funnel-step"><div class="funnel-label">'+s.label+'</div><div class="funnel-count">'+s.count+'</div><div class="funnel-bar-wrap"><div class="funnel-bar" style="width:'+p+'%;background:'+s.color+'"><span>'+cv+'</span></div></div><div class="funnel-pct">'+cv+'</div></div>';});el.innerHTML=h;}

function renderOrders(){var f=filterByDate(allOrders);var sf=document.getElementById('filter-status').value;var tf=document.getElementById('filter-type').value;if(sf!=='all')f=f.filter(function(o){return o.status===sf;});if(tf!=='all')f=f.filter(function(o){return o.order_type===tf;});var body=document.getElementById('orders-body');if(f.length===0){body.innerHTML='<tr><td colspan="6"><div class="empty"><div class="empty-icon">ü¶ê</div><div class="empty-text">No hay pedidos</div></div></td></tr>';return;}var rows='';f.forEach(function(o){var c=o.customer_name||'‚Äî';if(o.customer_phone)c+='<br><small style="color:var(--muted)">'+o.customer_phone+'</small>';if(o.delivery_address)c+='<br><small style="color:var(--muted)">üìç '+o.delivery_address+'</small>';if(o.table_number)c+='<br><small style="color:var(--muted)">Mesa '+o.table_number+'</small>';if(o.pickup_time)c+='<br><small style="color:var(--muted)">‚è± '+o.pickup_time+'</small>';var it='';if(o.items&&Array.isArray(o.items))it=o.items.map(function(i){return'<strong>'+i.qty+'x</strong> '+i.name;}).join('<br>');var sts=['pending','confirmed','preparing','ready','delivered','cancelled'];var sel='<select class="status-select" onchange="updateStatus(\''+o.id+'\',this.value)">';sts.forEach(function(s){sel+='<option value="'+s+'"'+(s===o.status?' selected':'')+'>'+statusLabel(s)+'</option>';});sel+='</select>';rows+='<tr><td style="white-space:nowrap">'+fTime(o.created_at)+'<br><small style="color:var(--muted)">'+new Date(o.created_at).toLocaleDateString('es-MX',{day:'2-digit',month:'short'})+'</small></td><td><span class="otype '+o.order_type+'">'+typeLabel(o.order_type)+'</span></td><td>'+c+'</td><td><div class="items-list">'+it+'</div></td><td style="white-space:nowrap;font-family:Bebas Neue;font-size:1rem;color:var(--gold)">'+fMoney(o.total)+'</td><td>'+sel+'</td></tr>';});body.innerHTML=rows;}

async function updateStatus(id,st){var{error}=await sb.from('orders').update({status:st}).eq('id',id);if(error){alert('Error');return;}var o=allOrders.find(function(x){return x.id===id;});if(o)o.status=st;renderAll();}

function renderLeads(){var f=filterByDate(allLeads);var sf=document.getElementById('filter-source').value;if(sf!=='all')f=f.filter(function(l){return l.source===sf;});var body=document.getElementById('leads-body');if(f.length===0){body.innerHTML='<tr><td colspan="5"><div class="empty"><div class="empty-icon">üë•</div><div class="empty-text">No hay leads</div></div></td></tr>';return;}var rows='';f.forEach(function(l){rows+='<tr><td style="white-space:nowrap">'+fDate(l.created_at)+'</td><td>'+(l.name||'‚Äî')+'</td><td>'+(l.phone||'‚Äî')+'</td><td>'+(l.email||'‚Äî')+'</td><td><span class="otype recoger">'+(l.source||'bar')+'</span></td></tr>';});body.innerHTML=rows;}

function renderAnalytics(){var orders=filterByDate(allOrders);var active=orders.filter(function(o){return o.status!=='cancelled';});var cancelled=orders.filter(function(o){return o.status==='cancelled';});var leads=filterByDate(allLeads);var cr=leads.length>0&&active.length>0?Math.round(active.length/leads.length*100):0;document.getElementById('a-conversion').textContent=cr+'%';var phones={};active.forEach(function(o){if(o.customer_phone)phones[o.customer_phone]=(phones[o.customer_phone]||0)+1;});document.getElementById('a-repeat').textContent=Object.values(phones).filter(function(c){return c>=2;}).length;var ti=0;active.forEach(function(o){if(o.items&&Array.isArray(o.items))o.items.forEach(function(i){ti+=(i.qty||1);});});document.getElementById('a-avg-items').textContent=active.length>0?(ti/active.length).toFixed(1):'0';document.getElementById('a-cancel-rate').textContent=orders.length>0?Math.round(cancelled.length/orders.length*100)+'%':'0%';
var wd=[0,0,0,0,0,0,0];var wl=['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];active.forEach(function(o){wd[new Date(o.created_at).getDay()]+=Number(o.total);});var c1=document.getElementById('chart-weekday');if(chartWeekday)chartWeekday.destroy();chartWeekday=new Chart(c1,{type:'bar',data:{labels:wl,datasets:[{data:wd,backgroundColor:wd.map(function(v,i){return i===5||i===6?'rgba(242,107,29,.5)':'rgba(201,162,77,.4)';}),borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#A0B4C0',font:{size:10}},grid:{display:false}},y:{ticks:{color:'#A0B4C0',font:{size:9},callback:function(v){return'$'+v.toLocaleString();}},grid:{color:'rgba(255,255,255,.03)'}}}}});
var bk={'$0-100':0,'$101-200':0,'$201-300':0,'$301-500':0,'$500+':0};active.forEach(function(o){var t=Number(o.total);if(t<=100)bk['$0-100']++;else if(t<=200)bk['$101-200']++;else if(t<=300)bk['$201-300']++;else if(t<=500)bk['$301-500']++;else bk['$500+']++;});var c2=document.getElementById('chart-ticket');if(chartTicket)chartTicket.destroy();chartTicket=new Chart(c2,{type:'bar',data:{labels:Object.keys(bk),datasets:[{data:Object.values(bk),backgroundColor:'rgba(139,92,246,.4)',borderColor:'#8B5CF6',borderWidth:1,borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#A0B4C0',font:{size:9}},grid:{display:false}},y:{ticks:{color:'#A0B4C0',font:{size:9},stepSize:1},grid:{color:'rgba(255,255,255,.03)'}}}}});}

function renderProducts(){var orders=filterByDate(allOrders).filter(function(o){return o.status!=='cancelled';});var items={};orders.forEach(function(o){if(o.items&&Array.isArray(o.items))o.items.forEach(function(i){var k=i.name;if(!items[k])items[k]={name:k,qty:0,revenue:0};items[k].qty+=(i.qty||1);items[k].revenue+=(i.qty||1)*(i.price||0);});});var sorted=Object.values(items).sort(function(a,b){return b.qty-a.qty;});var el=document.getElementById('top-products');if(sorted.length===0){el.innerHTML='<div class="empty"><div class="empty-icon">ü¶ê</div><div class="empty-text">Sin datos a√∫n</div></div>';return;}var h='';sorted.slice(0,20).forEach(function(it,i){h+='<div class="top-item"><div class="top-rank">'+(i+1)+'</div><div class="top-name">'+it.name+'</div><div class="top-qty">√ó'+it.qty+'</div><div class="top-rev">'+fMoney(it.revenue)+'</div></div>';});el.innerHTML=h;}

function exportOrders(){var f=filterByDate(allOrders);var csv='Fecha,Tipo,Cliente,Telefono,Direccion,Mesa,HoraRecogida,Items,Total,Status\n';f.forEach(function(o){var it=o.items?o.items.map(function(i){return i.qty+'x '+i.name;}).join(' | '):'';csv+='"'+fDate(o.created_at)+'","'+o.order_type+'","'+(o.customer_name||'')+'","'+(o.customer_phone||'')+'","'+(o.delivery_address||'')+'","'+(o.table_number||'')+'","'+(o.pickup_time||'')+'","'+it+'",'+o.total+',"'+o.status+'"\n';});downloadCSV(csv,'anastacio_pedidos_'+dateRange+'.csv');}
function exportLeads(){var f=filterByDate(allLeads);var csv='Fecha,Nombre,Telefono,Email,Fuente\n';f.forEach(function(l){csv+='"'+fDate(l.created_at)+'","'+(l.name||'')+'","'+(l.phone||'')+'","'+(l.email||'')+'","'+(l.source||'')+'"\n';});downloadCSV(csv,'anastacio_leads_'+dateRange+'.csv');}
function downloadCSV(csv,fn){var b=new Blob([csv],{type:'text/csv;charset=utf-8;'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=fn;a.click();}

function setupRealtime(){sb.channel('admin-rt').on('postgres_changes',{event:'INSERT',schema:'public',table:'orders'},function(p){showNotification('ü¶ê ¬°NUEVO PEDIDO! ‚Äî '+typeLabel(p.new.order_type)+' ‚Äî '+fMoney(p.new.total));loadAll();}).on('postgres_changes',{event:'INSERT',schema:'public',table:'leads'},function(){loadAll();}).subscribe();}
setInterval(loadAll,10000);

if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(reg) {
      console.log('SW registered:', reg.scope);
    }).catch(function(err) {
      console.log('SW failed:', err);
    });
  });
}
</script>
</body>
</html>
